---
- name: Bootstrap Grafana and Prometheus
  hosts: hosts
  become: yes

  # testing locally first
  # already install pre-reqs when installing ansible
  # todo - change hosts to web_servers
  tasks:
  - debug: 
      var: ansible_facts 

  - name: download apt key
    ansible.builtin.apt_key:
      url: https://packages.grafana.com/gpg.key
      state: present

  - name: Add Grafana repo to sources list
    ansible.builtin.apt_repository:
      repo: deb https://packages.grafana.com/oss/deb stable main
      state: present
      filename: grafana
      
  - name: Update apt cahce and install Grafana
    ansible.builtin.apt:
      name: grafana
      update_cache: yes

  - name: Start and enable Grafana service
    ansible.builtin.systemd_service:
      state: started
      name: grafana-server
      enabled: true

  - name: Download Pro
    ansible.builtin.get_url:
      url: https://github.com/prometheus/prometheus/releases/download/v2.32.1/prometheus-2.32.1.linux-amd64.tar.gz
      dest: /home/linuxadmin/

  - name: Unarchive a file that is already on the remote machine
    ansible.builtin.unarchive:
      src: /home/linuxadmin/prometheus-2.32.1.linux-amd64.tar.gz
      dest: /home/linuxadmin/

  - name: Ensure group "prometheus" exists
    ansible.builtin.group:
      name: prometheus
      state: present      

  - name: Added prometheus user to prometheus group
    ansible.builtin.user:
      name: prometheus
      shell: /sbin/nologin
      groups: prometheus
      
  # - name: Create a directory if it does not exist
  #   ansible.builtin.file:
  #     path: /etc/prometheus
  #     state: directory

  # - name: Create a directory if it does not exist
  #   ansible.builtin.file:
  #     path: /var/lib/prometheus
  #     state: directory

  - name: Create two directories links
    ansible.builtin.file:
      path: '{{ item.src }}'
      mode: '{{item.mode}}'
      state: directory
    loop:
      - { src: /etc/prometheus }
      - { src: /var/lib/prometheus }
      - { mode: '0755' }
      - { mode: '0777' }